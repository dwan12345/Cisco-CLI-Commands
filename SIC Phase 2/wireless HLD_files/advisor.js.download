/**
 * 
 */
var advisor = {
	isProcessing : false,
	apband : '',
	defaultModel : "EWS377AP",
	powerValue : 1,
	powers : {
		power24 : 1,
		power5 : 1,
		power6: 1,
	},
	aderrorcount : 0
};

var slider = document.getElementById('powerRange');
noUiSlider.create(slider, {
	start : 26,
	step : 1,
	connect : true,
	range : {
		'min' : 1,
		'max' : 26
	},
	format : wNumb({
		decimals : 0
	})
});
slider.noUiSlider.on('update', function(values, handle) {
	$("#powerlabel").html(Math.round(values[handle]) + "dBm");
	advisor.powerValue = Math.round(values[handle]);
});

function initAdvisor() {

	$("#processingBtn").removeClass("processing");
	$("#processingBtn").html("Run");
	$("#ad_ap_list").unbind("change");
	$("#ad_ap_list").change(function() {
		setApInfo();

	});
	setApInfo();
	$("#ad_strengthlist").val(-70);
}

function changeBand() {
	var band = $("#ad_bandlist").val();
	if (band == "2.4") {
		slider.noUiSlider.updateOptions({
			range : {
				'min' : 1,
				'max' : advisor.powers.power24
			}
		});
		slider.noUiSlider.set(11);
		advisor.powerValue = 11;
	} else if (band === '5.0') {
		slider.noUiSlider.updateOptions({
			range : {
				'min' : 1,
				'max' : advisor.powers.power5
			}
		});
		slider.noUiSlider.set(17);
		advisor.powerValue = 17;
	}
	else if (band === '6.0') {
		slider.noUiSlider.updateOptions({
			range : {
				'min' : 1,
				'max' : advisor.powers.power6
			}
		});
		slider.noUiSlider.set(17);
		advisor.powerValue = 17;
	}
}

function setApInfo() {
	var ap = $("#ad_ap_list").val();
	if (ap == 'Auto') {
		ap = advisor.defaultModel;
	}
	var param = {
		"modelId" : ap
	};
	doActionParam(loader.Request.SystemGetAp, param, function(data) {
		if (!data || !data.success) {
			return;
		}
		var dimlist = data.dimAps;
		if (!dimlist)
			return;
		var len = dimlist.length;
		var option = "";
		var band = null;
		advisor.apband = "";
		for (var i = 0; i < dimlist.length; i++) {

			var tphtml = "";
			for (var t = 1; t <= dimlist[i].transmiterPower; t++) {
				tphtml += "<option>" + t + "</option>";
			}
			if (dimlist[i].bandName == "2.4") {
				option += "<option value='2.4'>2.4GHz</option>";
				band = '2.4';
				advisor.powers.power24 = dimlist[i].transmiterPower;
				if (len == 1) {
					advisor.apband = "2.4";
				}
			} else if (dimlist[i].bandName == "5.0") {
				if (dimlist[i].apType == 0) {
					if (global.support.band5In) {
						option += "<option value='5.0'>5GHz</option>";
						if (!band) {
							band = '5.0';
						}
						advisor.powers.power5 = dimlist[i].transmiterPower;
						if (len == 1) {
							advisor.apband = "5.0";
						}
					}
				} else {
					if (global.support.band5Out) {
						option += "<option value='5.0'>5GHz</option>";
						if (!band) {
							band = '5.0';
						}
						advisor.powers.power5 = dimlist[i].transmiterPower;
						if (len == 1) {
							advisor.apband = "5.0";
						}
					}
				}
			}
			else if (dimlist[i].bandName == "6.0") {
				if (dimlist[i].apType == 0) {
					if (global.support.band6In) {
						option += "<option value='6.0'>6GHz</option>";
						if (!band) {
							band = '6.0';
						}
						advisor.powers.power6 = dimlist[i].transmiterPower;
						if (len == 1) {
							advisor.apband = "6.0";
						}
					}
				} else {
					if (global.support.band6Out) {
						option += "<option value='6.0'>6GHz</option>";
						if (!band) {
							band = '6.0';
						}
						advisor.powers.power6 = dimlist[i].transmiterPower;
						if (len == 1) {
							advisor.apband = "6.0";
						}
					}
				}
			}
			$("#ad_bandlist").html(option);
			
			// if (band == "2.4") {
			// 	$("#ad_bandlist").val("2.4");
			// } else {
			// 	$("#ad_bandlist").val("5.0");
			// }
			$("#ad_bandlist").val(band);

			$('select').material_select();
			$("#ad_bandlist").unbind("change");
			$("#ad_bandlist").change(function() {
				changeBand();
			});
			changeBand();
		}
	});
}

/* 保存自动计算的条件 */
function runAdvisor() {
	$("#warningP").hide();
	showDialog('waitingPModal');
	var apmode = $("#ad_ap_list").val();
	if (apmode == 'Auto') {
		apmode = advisor.defaultModel;
	}
	var jsondata = {};
	var ap = {
		"floorId" : global.currentFloor.floorId,
		"apModel" : apmode,
		"bandList" : []
	};
	ap.bandList.push({
		"bandName" : $("#ad_bandlist").val(),
		"pt" : advisor.powerValue
	});
	jsondata.floorId = global.currentFloor.floorId;
	jsondata.coveragePercent = 100;
	jsondata.mainBand = $("#ad_bandlist").val();
	jsondata.minimumDbm = $("#ad_strengthlist").val();
	global.currentBand = jsondata.mainBand;
	advisor.minimumDbm = jsondata.minimumDbm;
	jsondata.apBo = ap;
	advisor.isProcessing = true;
	showPercent("2%");
	advisor.aderrorcount = 0;
	//getAdvisorProcess();
	doAction(loader.Request.FloorAdvisorHeatMap, jsondata, function(data) {
		if (data.success && data.data) {
			showPercent("95%");
			advisor.isProcessing = false;
			var atlist = data.advisorResult.addAtList;
			// 计算channel
			doActionParam(loader.Request.FloorAutoChannelAdvisor2, jsondata,
					function(data) {
						if (data && data.success) {
							showPercent("100%");
							advisorRefresh(data.data, atlist);
							setTimeout(function() {
								closeDialog('advisorModal');
								if ($("#ad_bandlist").val() == "2.4") {
									global.currentBand = "24";
								} else {
									global.currentBand = "5";
								}
							
								global.showheatmap = true;
								global.currentChannel = "All";
								$("#menuChannel span").html("All");
								if (global.currentBand == "24") {
									$("#band24radio").prop("checked", true);
								} else {
									$("#band5radio").prop("checked", true);
								}
								//showDialog('waitingPModal');
								showHeatMapModal(false, 0);

							}, 100);
						}
					});

			return;
		}else{
			closeDialog('waitingPModal');
			if(data.msgCode=='full'){
				$("#warningP").show();
			}else{
				$("#errorP").show();
			}
			$("#processingBtn").removeClass("processing");
			$("#processingBtn").html("Run");
		     advisor.isProcessing=false;
	
		}

	});

}
function cancelAdvisor() {
	closeDialog('advisorModal');
	if (advisor.isProcessing) {
		changeHand();
		var jsondata = {
			"stop" : "true",
			"floorId" : global.currentFloor.floorId
		};

		doActionParam(loader.Request.FloorAdvisorProcessing, jsondata,
				function(data) {
					showPercent("2%");
				});
	}

}
function showPercent(process) {
	if (process == '100%') {
		$("#processingBtn").removeClass("processing");
		$("#processingBtn").html("Completed");
	}
	if (!$("#processingBtn").hasClass("processing")) {
		$("#processingBtn").addClass("processing");
	}
	if (process) {
		$("#processingBtn").html("Running..." + process);
	} else {
		$("#processingBtn").html("Running...");
	}
}

function getAdvisorProcess() {
	var jsondata = {
		"floorId" : global.currentFloor.floorId,
		"stop" : "false"
	};
	doActionParam(
			loader.Request.FloorAdvisorProcessing,
			jsondata,
			function(data) {
				if (data && data.success) {
					if (data.advisorResult.calculateProcessing > 0.02) {
						var percent = parseInt((parseInt(data.advisorResult.calculateProcessing * 100)) * 0.9)
								+ "%";
						showPercent(percent);
					}

				}
				if (advisor.isProcessing) {
					getAdvisorProcess();
				}
				// setTimeout(getAdvisorProcess, 200);
			});

}
