/*
 * 资产列表的显示与保存
 */
// 缓存当前数据
var inventory;
// 缓存初始数据
var cacheData;

var removeList = [];// 删除列表
var changeList = [];// 修改列表

var clipboard = new Clipboard('#d_clip_button', {
    text: copyAPInformation
});

clipboard.on('success', function(e) {
	$("a.removedTip").html("Copied!");
	$("a.removedTip").show();
	setTimeout(function() {
		$("a.removedTip").hide();
	}, 2000);
});

clipboard.on('error', function(e) {
    console.log(e);
});
var sort = {
		name : 'apName',
		asc : true
	};
var inventoryCache = function(aps) {
	this.apList = [];
	for (var i = 0; i < aps.length; i++) {
		var ap = {};
		this.apList.push(ap);
		if (aps[i].select) {
			ap.select = aps[i].select;
		} else {
			ap.select = false;
		}

		ap.apId = aps[i].apId;
		ap.apName = aps[i].apName;
		ap.apLocation = aps[i].apLocation;
		if (aps[i].bandList != null) {
			ap.bandList = [];
			for (var j = 0; j < aps[i].bandList.length; j++) {
				var band = {};
				band.bandName = aps[i].bandList[j].bandName;
				band.enable = aps[i].bandList[j].enable;
				band.channel = aps[i].bandList[j].channel;
				band.apMode = aps[i].bandList[j].apMode;
				band.channelSize=aps[i].bandList[j].channelSize;
				band.pt = aps[i].bandList[j].pt;
				ap.bandList.push(band);
			}

		}
	}
};

// 弹出窗关闭处理
function releaseCache() {
	if (!inventory)
		return;
	for (var i = 0; i < inventory.apList.length; i++) {
		if (checkChache(inventory.apList[i], null)) {
			changeList.push(inventory.apList[i]);
			continue;
		} else {
			if (inventory.apList[i].bandList != null) {
				for (var j = 0; j < inventory.apList[i].bandList.length; j++) {
					if (checkChache(inventory.apList[i],
							inventory.apList[i].bandList[j])) {
						changeList.push(inventory.apList[i]);
						break;
					}
				}
			}
		}
	}
	// 通知删除，和修改
	if (removeList.length > 0 || changeList.length > 0) {
		changeShowHeatMap();
		inventoryRefresh(removeList, changeList);
	}
}

/*
 * 显示资产弹出窗
 */
function showInventory() {
	clearInventorySearch();
	$("#InventoryBody").html("");
	$('table#inventoryTable').editTable();

	removeList = [];
	changeList = [];
	$("#ckall").prop("checked", false);
	$("#actionDiv li").addClass("disable");
	$("#Tablesearch").val("");
	if ($(".searchico").hasClass("search-remove")) {
		$(".searchico").removeClass("search-remove").addClass("search-search");
	}

	showDialog('inventoryModal');
	showInventoryInfo(inventory);
	$('table#inventoryTable').editTable();
	// 去掉赋值按钮的手型鼠标状态
	$("#actionDiv li.copyap").hide();
	$("#actionDiv li.deleteap").hide();
	$("#actionDiv li.exportcsv").hide();
	var jsondata = {
		"floorId" : global.currentFloor.floorId
	};
	doAction(loader.Request.FloorGetDetails, jsondata, function(data) {
		if (!data || !data.success) {
			return;
		}
		inventory = data.data;
		showInventoryInfo(data.data);
		$('table#inventoryTable').editTable();

	});

}
function sortInventory(sender, tag) {
	var compare = function(prop, mode) {
		return function(obj1, obj2) {
			var val1 = obj1[prop];
			var val2 = obj2[prop];
			if (prop.indexOf("band") != -1) {
				var tempprop = prop.substring(5, prop.length);
				for (var i = 0; i < obj1["bandList"].length; i++) {
					if (obj1["bandList"][i].bandName == "2.4") {
						val1 = obj1["bandList"][i][tempprop];
					}
				}
				if (!val1) {
					val1 = obj1["bandList"][0][tempprop];
				}
				for (var i = 0; i < obj2["bandList"].length; i++) {
					if (obj2["bandList"][i].bandName == "2.4") {
						val2 = obj2["bandList"][i][tempprop];
					}
				}
				if (!val2) {
					val2 = obj2["bandList"][0][tempprop];
				}
			}
			if(prop=="band.channel"){
				if(val1=="Auto") val1=0;
				if(val2=="Auto") val2=0;
				val1=parseInt(val1);
				val2=parseInt(val2);
			}
			if (prop == "select") {
				if (val1) {
					val1 = 1;
				} else {
					val1 = 0;
				}
				if (val2) {
					val2 = 1;
				} else {
					val2 = 0;
				}
			}
			if(prop=="apName"){

				if (val1.length < val2.length) {
					if (mode == 'DESC') {
						return 1;
					} else {
						return -1;
					}

				} else if (val1.length > val2.length) {
					if (mode == 'DESC') {
						return -1;
					} else {
						return 1;
					}
				} else {
					
					if (val1 < val2) {
						if (mode == 'DESC') {
							return 1;
						} else {
							return -1;
						}

					} else if (val1 > val2) {
						if (mode == 'DESC') {
							return -1;
						} else {
							return 1;
						}
					} else {
						return 0;
					}
				}
			}

			if (val1 < val2) {
				if (mode == 'DESC') {
					return 1;
				} else {
					return -1;
				}

			} else if (val1 > val2) {
				if (mode == 'DESC') {
					return -1;
				} else {
					return 1;
				}
			} else {
				return 0;
			}
		};
	};
	if (sort.name == tag) {
		if (sort.asc) {
			sort.asc = false;
			inventory.apList = inventory.apList.sort(compare(tag, 'DESC'));
		} else {
			sort.asc = true;
			inventory.apList = inventory.apList.sort(compare(tag, 'ASC'));
		}

	} else {
		sort.asc = true;
		inventory.apList = inventory.apList.sort(compare(tag, 'ASC'));
	}
	$("#inventoryTable th i.active").removeClass("active").removeClass(
			"fa-sort-asc").removeClass("fa-sort-desc").addClass("fa-sort");
	if (sort.asc) {
		$(sender).children("i").removeClass("fa-sort").addClass("fa-sort-asc")
				.addClass("active");
	} else {
		$(sender).children("i").removeClass("fa-sort").addClass("fa-sort-desc")
				.addClass("active");
	}
	;

	showInventoryInfo(inventory);
	$('table#inventoryTable').editTable();
	sort.name = tag;

}
/**
 * 重新给channel赋值
 * 
 * @param ap
 * @returns {String}
 */
/*function getProtocol(ap) {
	var ppString = "";
	if (ap.bandList != null) {
		for (var j = 0; j < ap.bandList.length; j++) {
			if (ap.bandList[j].enable == 0) {
				if (ppString != "") {
					ppString += "/";
				}
				ppString += ap.bandList[j].channel + "("
						+ ap.bandList[j].bandName + "G)";
			}
		}
	}
	return ppString;
}*/
/**
 * 检查AP的属性是否发生了变化
 * 
 * @param ap
 * @param band
 * @returns {Boolean} 属性是否变了
 */
function checkChache(ap, band) {
	for (var i = 0; i < cacheData.apList.length; i++) {
		if (band == null) {
			if (cacheData.apList[i].apId == ap.apId) {
				if (cacheData.apList[i].apName != ap.apName)
					return true;
				if (cacheData.apList[i].apLocation != ap.apLocation)
					return true;
			}
		} else {
			if (cacheData.apList[i].apId == band.apId) {
				if (cacheData.apList[i].bandList != null) {
					for (var j = 0; j < cacheData.apList[i].bandList.length; j++) {
						if (cacheData.apList[i].bandList[j].bandName == band.bandName) {
							if (cacheData.apList[i].bandList[j].enable != band.enable) {
								return true;
								// ap.protocol = getProtocol(ap);
							}
							if (cacheData.apList[i].bandList[j].apMode != band.apMode)
								return true;
							if (cacheData.apList[i].bandList[j].channel != band.channel)
								return true;
							if (cacheData.apList[i].bandList[j].channelSize != band.channelSize)
								return true;
							if (cacheData.apList[i].bandList[j].pt != band.pt)
								return true;
						}
					}
				}
			}
		}
	}
	return false;
}
// 加载资产内容
function showInventoryInfo(obj, searchText) {
	if (!obj)
		return;
	cacheData = new inventoryCache(obj.apList);
	var aplist = obj.apList;
	var atlist = obj.atList;
	var html = "";
	var deschtml = "";
	var atcount = 0;
	var apcount = 0;
	if (aplist) {
		var len = aplist.length;
		apcount = len;
		if (atlist)
			atcount = atlist.length;
		for (var i = 0; i < len; i++) {
			if (i == len - 1) {
				html += getApHtml(aplist[i], atlist, true, searchText);
			} else {
				html += getApHtml(aplist[i], atlist, false, searchText);
			}

		}
	}
	if (html == '') {
		$("#noResultDiv").show();
		$("#tbdiv").hide();
		$("#tbheader").hide();
	} else {
		$("#noResultDiv").hide();
		$("#tbdiv").show();
		$("#tbheader").show();
		$("#InventoryBody").html(html);
	}

}
function showAPCount(apcount, atcount) {
	var deschtml = "";
	deschtml = "<p style='height: 28px;line-height: 28px;margin: 0px;'><span style='font-weight:bold;color:#e97920;'>"
			+ apcount + "</span><span> Access Points</span>";
	if (atcount > 0) {
		deschtml = "<p style='height: 28px;line-height: 28px;margin: 0px;'><span style='font-weight:bold;color:#e97920;'>"
				+ apcount + "</span><span> Access Points, </span>";
		deschtml += "<span style='font-weight:bold;color:#e97920;'>" + atcount
				+ "</span><span> External Antennas</span>";
	}
	deschtml += "</p>";
	$("#inventoryDesc").html(deschtml);
}
// ap信息
function getApHtml(ap, atlist, islast, searchText) {
	var html = "";
	// 是否包含搜索内容：不包含则不添加
	var isContains = false;
	var bandcount = ap.bandList.length;
	var ff = "";
	if (bandcount == 1 || (bandcount == 2 && !global.support.band5In)) {
		if (ap.select) {
			ff += "<td style='width:85px;'><p style='margin:0 0 0 14px;'><input id='ck_"
					+ ap.apId
					+ "' type='checkbox' class='filled-in' name='ckb'  onchange='stopPP(arguments[0]);itemCheck(this);' value='"
					+ ap.apId + "' checked='checked'/><label for='ck_" + ap.apId
					+ "'></label></p></td>";
		} else {
			ff += "<td style='width:85px;'><p style='margin:0 0 0 14px;'><input id='ck_"
					+ ap.apId
					+ "' type='checkbox' class='filled-in' name='ckb'  onchange='stopPP(arguments[0]);itemCheck(this);' value='"
					+ ap.apId + "'/><label for='ck_" + ap.apId
					+ "'></label></p></td>";
		}
		ff += "<td style='width:135px;' EditType='TextBox' Value='" + ap.apName + "'>" + ap.apName
				+ "</td>";
		ff += "<td style='width:165px;' Value='" + ap.bandType + "'>" + ap.apModel + "</td>";

	} else {
		if (ap.select) {
			ff += `<td style='width:85px;' rowspan='${bandcount}'><p style='margin:0 0 0 14px;'><input id='`
					+ ap.apId
					+ "' type='checkbox' class='filled-in'  name='ckb' onchange='stopPP(arguments[0]);itemCheck(this);' value='"
					+ ap.apId + "' checked='checked'/><label for='" + ap.apId
					+ "'></label></p></td>";
		} else {
			ff += `<td style='width:85px;' rowspan='${bandcount}'><p style='margin:0 0 0 14px;'><input id='ck_`
					+ ap.apId
					+ "' type='checkbox' class='filled-in'  name='ckb' onchange='stopPP(arguments[0]);itemCheck(this);' value='"
					+ ap.apId + "'/><label for='ck_" + ap.apId
					+ "'></label></p></td>";
		}
		/*if (ap.select) {
			ff += "<td rowspan='2'><input type='checkbox' style='margin:0px 10px;' name='ckb' onclick='stopPP(arguments[0]);itemCheck(this);' value='"
					+ ap.apId + "' checked='checked'/></td>";
		} else {
			ff += "<td rowspan='2'><input type='checkbox' style='margin:0px 10px;' name='ckb' onclick='stopPP(arguments[0]);itemCheck(this);' value='"
					+ ap.apId + "'/></td>";
		}*/

		ff += `<td style='width:135px;' EditType='TextBox' rowspan='${bandcount}' Value='` + ap.apName + "'>"
				+ ap.apName + "</td>";
		ff += `<td style='width:165px;' rowspan='${bandcount}' value='` + ap.bandType + "'>" + ap.apModel
				+ "</td>";
	}
	for (var m = 0; m < bandcount; m++) {
	
		if ((!global.support.band5In && ap.apType == 0) || (!global.support.band5Out && ap.apType == 1)) {
			if (ap.bandList[m].bandName == "5.0") {
				continue;
			}
		}
		if ((!global.support.band6In && ap.apType == 0) || (!global.support.band6Out && ap.apType == 1)) {
			if (ap.bandList[m].bandName == "6.0") {
				continue;
			}
		}
		if (bandcount == 1) {
			html += "<tr class='normalRow'>";
		} else if (bandcount == 2) {
			if ((global.support.band5In && ap.apType == 0) || (global.support.band5Out && ap.apType == 1)) {
				if (m == 1) {
					html += "<tr class='normalRow' style='height:30px;border-top:none;'>";
				} else {
					html += "<tr class='normalRow' style='height:30px;'>";
				}
			}
			else{
				html += "<tr class='normalRow'>";
			}
		}
		else if (bandcount == 3) {
			if ((global.support.band5In && ap.apType == 0) || (global.support.band5Out && ap.apType == 1) ||
				(global.support.band6In && ap.apType == 0) || (global.support.band6Out && ap.apType == 1)) {
				if (m == 0) {
					html += "<tr class='normalRow' style='height:30px'>";
				}
				else {
					html += "<tr class='normalRow' style='height:30px;border-top:none;'>";
				}
			}
		}

		if (m == 0) {
			html += ff;
		}
		if (ap.bandList[m].enable == 0) {
			html += "<td style='width:115px;' id='" + ap.bandList[m].bandName
					+ "' EditType='DropDownList' isControl='true' Value='"
					+ ap.bandList[m].enable + "' DataItems='"
					+ getEnabled(ap.bandList[m].bandName + "GHz") + "'>"
					+ ap.bandList[m].bandName + "GHz On</td>";
			html += "<td style='width:90px;' EditType='DropDownList' DataItems='" + getAPMode()
					+ "'  Value='" + ap.bandList[m].apMode + "'>"
					+ ap.bandList[m].apMode + "</td>";
			if (ap.bandList[m].bandName == "2.4") {
				html += "<td style='width:105px;' EditType='DropDownList' Value='"
						+ ap.bandList[m].channel + "'  DataItems='"
						+ getChannel24() + "'>" + ap.bandList[m].channel
						+ "</td>";
				html += "<td style='width:125px;' EditType='DropDownList' DataItems='"
					+ getChannelSize() + "' Value='"
					+ ap.bandList[m].channelSize + "'>"
					+ ap.bandList[m].channelSize + " MHz</td>";
			} else if (ap.bandList[m].bandName == "5.0") {
				html += "<td style='width:105px;'EditType='DropDownList' Value='"
						+ ap.bandList[m].channel + "'  DataItems='"
						+ getChannel5(ap.bandList[m].channelSize, ap.apType) + "'>"
						+ ap.bandList[m].channel + "</td>";
				html += "<td style='width:125px;' EditType='DropDownList' DataItems='"
					+ get5GChannelSize(ap.bandList[m].protocol,ap.apType) + "' Value='"
					+ ap.bandList[m].channelSize + "'>"
					+ ap.bandList[m].channelSize + " MHz</td>";
			} else if (ap.bandList[m].bandName == "6.0") {
				html += "<td style='width:105px;'EditType='DropDownList' Value='"
						+ ap.bandList[m].channel + "'  DataItems='"
						+ getChannel6(ap.bandList[m].channelSize, ap.apType) + "'>"
						+ ap.bandList[m].channel + "</td>";
				html += "<td style='width:125px;' EditType='DropDownList' DataItems='"
					+ get6GChannelSize(ap.bandList[m].protocol,ap.apType) + "' Value='"
					+ ap.bandList[m].channelSize + "'>"
					+ ap.bandList[m].channelSize + " MHz</td>";
			}
			
			html += "<td style='width:125px;' EditType='DropDownList' DataItems='"
					+ getPt(ap.bandList[m].defaultPt) + "' Value='"
					+ ap.bandList[m].pt + "'>" + ap.bandList[m].pt + " dBm</td>";
			
			if (bandcount == 1) {
				html += "<td style='width:135px;' EditType='TextBox' Value='" + ap.apLocation + "'>" + ap.apLocation + "</td>";
			} else {
				if ((global.support.band5In && ap.apType == 0) || (global.support.band5Out && ap.apType == 1)){
					if (m == 0) {
						html += "<td style='width:135px;' rowspan='2' EditType='TextBox' Value='" + ap.apLocation + "'>" + ap.apLocation + "</td>";
					} 
				}
				else{
					html += "<td style='width:135px;' EditType='TextBox' Value='" + ap.apLocation + "'>" + ap.apLocation + "</td>";
				}
			}
		} else {
			html += "<td style='opacity:0.5;width:115px;' id='" + ap.bandList[m].bandName
					+ "' EditType='DropDownList' isControl='true' Value='"
					+ ap.bandList[m].enable + "' DataItems='"
					+ getEnabled(ap.bandList[m].bandName + "GHz") + "'>"
					+ ap.bandList[m].bandName + "GHz Off</td>";
			html += "<td style='opacity:0.5;width:90px;'  DataItems='" + getAPMode()
					+ "'  Value='" + ap.bandList[m].apMode + "'>"
					+ ap.bandList[m].apMode + "</td>";
			if (ap.bandList[m].bandName == "2.4") {
				html += "<td style='opacity:0.5;width:105px;'  Value='"
						+ ap.bandList[m].channel + "'  DataItems='"
						+ getChannel24() + "'>" + ap.bandList[m].channel
						+ "</td>";
				html += "<td style='opacity:0.5;width:125px;'  DataItems='"
					+ getChannelSize() + "' Value='"
					+ ap.bandList[m].channelSize + "'>"
					+ ap.bandList[m].channelSize + " MHz</td>";
			} else if (ap.bandList[m].bandName == "5.0") {
				html += "<td style='opacity:0.5;width:105px;'  Value='"
						+ ap.bandList[m].channel + "'  DataItems='"
						+ getChannel5(ap.bandList[m].channelSize, ap.apType) + "'>"
						+ ap.bandList[m].channel + "</td>";
				html += "<td style='opacity:0.5;width:125px;'  DataItems='"
					+ get5GChannelSize(ap.bandList[m].protocol,ap.apType) + "' Value='"
					+ ap.bandList[m].channelSize + "'>"
					+ ap.bandList[m].channelSize + " MHz</td>";
			} else if (ap.bandList[m].bandName == "6.0") {
				html += "<td style='opacity:0.5;width:105px;'  Value='"
						+ ap.bandList[m].channel + "'  DataItems='"
						+ getChannel6(ap.bandList[m].channelSize, ap.apType) + "'>"
						+ ap.bandList[m].channel + "</td>";
				html += "<td style='opacity:0.5;width:125px;'  DataItems='"
					+ get6GChannelSize(ap.bandList[m].protocol,ap.apType) + "' Value='"
					+ ap.bandList[m].channelSize + "'>"
					+ ap.bandList[m].channelSize + " MHz</td>";
			}
			
			html += "<td style='opacity:0.5;width:125px;'   DataItems='"
					+ getPt(ap.bandList[m].defaultPt) + "' Value='"
					+ ap.bandList[m].pt + "'>" + ap.bandList[m].pt + " dBm</td>";
			if (bandcount == 1) {
				html += "<td style='width:135px;' EditType='TextBox' Value='" + ap.apLocation + "'>" + ap.apLocation + "</td>";
			} else { 
				if ((global.support.band5In && ap.apType == 0) || (global.support.band5Out && ap.apType == 1)){
					if (m == 0) {
						html += "<td style='width:135px;' rowspan='2' EditType='TextBox' Value='" + ap.apLocation + "'>" + ap.apLocation + "</td>";
					} 
				}
				else{
					html += "<td style='width:135px;' EditType='TextBox' Value='" + ap.apLocation + "'>" + ap.apLocation + "</td>";
				}
			}
		}

		/*
		 * html += "<td>" + ap.bandList[m].gt + "</td>"; html +=
		 * addAntennaInfo(ap, atlist, m, bandcount);
		 */
		html += "</tr>";
		if (searchText != undefined) {
			$(html).find("td:gt(0)").each(
					function() {
						var tdvalue = $(this).html();
						var reg = new RegExp(searchText, 'i');
						if (tdvalue.match(reg)) {
							isContains = true;
						}
					});
		} else {
			isContains = true;
		}
	}
	if (isContains) {
		return html;
	} else {
		return "";
	}
}



// 选择当前页所有行
function checkAll() {

	var flag = $("#ckall").prop("checked");
	if (flag) {
		flag = true;
	} else {
		flag = false;
	}
	var ckbs = $("input[name=ckb]");
	var len = ckbs.length;
	for (var i = 0; i < len; i++) {
		var ck = ckbs.eq(i);
		var flag2 = ck.prop("checked");
		if (flag2) {
			flag2 = true;
		} else {
			flag2 = false;
		}
		if (flag != flag2) {
			ck.prop("checked", flag);
			itemCheck(ck.get(0),null, true);
		}
	}
}

// 表格单行checkbox选择事件
function itemCheck(srcObj,e, isall) {
	var ck = $(srcObj);
	var apId = ck.val();
	var aplist = inventory.apList;
	if (aplist) {
		var len = aplist.length;
		for (var i = 0; i < len; i++) {
			if (aplist[i].apId == apId) {
				aplist[i].select = ck.prop("checked");
				break;
			}
		}
	}
	var tr = ck.parent().parent();
	if (!tr.is("tr")) {
		tr = tr.parent();
	}
	var tdcount = $("#inventoryTable").find('thead th').length;
	var pre = tr.prev();
	var next = tr.next();
	var len = tr.children('td').length;
	/*if (len != tdcount) {
		ckToAddHighLight(ck, pre);
	} else {
		len = next.children('td').length;
		if (len != 0 && len != tdcount) {
			ckToAddHighLight(ck, next);
		}
	}*/
	//ckToAddHighLight(ck, tr);
	var ckbs = $("input[name=ckb]:checked");
	if (ckbs.length > 0) {
		$("#actionDiv li.copyap").show();
		$("#actionDiv li.deleteap").show();
		$("#actionDiv li.exportcsv").show();
	} else {
		$("#actionDiv li.copyap").hide();
		$("#actionDiv li.deleteap").hide();
		$("#actionDiv li.exportcsv").hide();
	}
	if (!isall) {
		setCheckAll();
	}

}
function setCheckAll() {
	var allckbs = $("input[name=ckb]");
	var alllen = allckbs.length;
	var flag2 = true;
	for (var i = 0; i < alllen; i++) {
		// if (i < curPage * pageSize && i >= (curPage - 1) * pageSize)
		{
			var ck = allckbs.eq(i);
			flag2 = ck.prop("checked");
			if (!flag2) {
				$("#ckall").prop("checked", false);
				break;
			}
		}
	}
	if (flag2)
		$("#ckall").prop("checked", true);
}
// 点击checkbox添加高亮
function ckToAddHighLight(ck, tr) {

	var checked = ck.prop("checked");
	var cl = "normalRow";
	if (checked) {
		if (tr.hasClass("specialRow")) {
			cl = "HighLightRow highLight";
		} else {
			cl = "HighLightRow";
		}

	} else {
		if (tr.hasClass("highLight")) {
			cl = "specialRow";
		} else {
			cl = "normalRow";
		}
	}
	// 没有mouseover和没有选中时的行样式
	tr.attr("class", cl);
}

// 删除AP
function delAp() {
	// 获取选中的复选框，然后循环遍历删除
	var tdcount = $("#inventoryTable").find('thead th').length;
	var ckbs = $("input[name=ckb]:checked");
	var apcount = inventory.apList.length;
	var atcount = 0;
	for (var i = 0; i < inventory.apList.length; i++) {
		if (inventory.apList[i].attachedId) {
			atcount += 1;
		}
	}
	var deleteList = [];
	ckbs.each(function() {
				var apId = $(this).val();
				deleteList.push(apId);
				var jsondata ={apId:apId};
				doAction(loader.Request.FloorDeleteAp, jsondata, function(data) {
					if (!data || !data.success) {
						return;
					}

				});
				if ($(this).parent().parent().parent().next().children('td').length < tdcount) {
					$(this).parent().parent().parent().next().remove();
				}
				$(this).parent().parent().parent().remove();
			});
	
	var len = inventory.apList.length;
	for (var i = len - 1; i >= 0; i--) {
		if (deleteList.contains(inventory.apList[i].apId)) {
			apcount = apcount - 1;
			if (inventory.apList[i].attachedId) {
				atcount = atcount - 1;
			}
			removeList.push(inventory.apList[i]);
			inventory.apList.splice(i, 1);
			
		}
	}
	$("a.removedTip").html("Removed!");
	$("a.removedTip").show();
	setTimeout(function() {
		$("a.removedTip").hide();
	}, 600);
	// showAPCount(apcount,atcount);
	$("#actionDiv li.copyap").hide();
	$("#actionDiv li.deleteap").hide();
	$("#actionDiv li.exportcsv").hide();
	$("#ckall").prop("checked", false);

}
//导出CSV
function exportCSV(){
	var fileName = "Inventory-"+global.currentFloor.floorName+ ".csv";
    var array = [];
    array.push("AP Name");
    array.push("Model");
    array.push("Radio Band");  
    array.push("Mode");
    array.push("Channel");
    array.push("Channel Size");   
    array.push("Power");    
    array.push("Location");
    var content = "";
    for (var i = 0; i < array.length; i++) {//这里是写入列名，即在页面上显示的名称
        var temp = (array[i]);
        if (temp != null && temp != "") {
        	content += "\"" + temp + "\",";
        }
    }
    content.substring(0, content.lastIndexOf(',') - 1);
    content += "\r\n";
	var ckbs = $("input[name=ckb]:checked");
	ckbs.each(function() {
		var apId = $(this).val();
		var aplist = inventory.apList;
		if (aplist) {
			var len = aplist.length;
			for (var i = 0; i < len; i++) {
				if (aplist[i].apId == apId) {
					for (var j = 0; j < aplist[i].bandList.length; j++) {
						if (j == 0) {
							content +="\"" + aplist[i].apName + "\",";
							content +="\"" + aplist[i].apModel + "\",";
						} else {
							content += "\"" +" " + "\",";
							content += "\"" +" " + "\",";
						}
						var state = "Off";
						if (aplist[i].bandList[j].enable == 0) {
							state = "On";

						}
						content +="\"" + aplist[i].bandList[j].bandName + "GHz "
								+ state + "\",";
						content += "\"" +aplist[i].bandList[j].apMode + "\",";
						content += "\"" +aplist[i].bandList[j].channel + "\",";
						content += "\"" +aplist[i].bandList[j].channelSize + "MHz\",";
						content += "\"" +aplist[i].bandList[j].pt + "dBm\",";
						if (j == 0) {
							content += "\"" +aplist[i].apLocation + "\"\r\n";
						} else {
							content +="\"" + " " + "\"\r\n";
						}

					}
					break;
				}

			}
		}

	});
	 if ('msSaveOrOpenBlob' in navigator) {
         var blob = new Blob([content], {type: "application/octet-stream"});
         // Microsoft Edge and Microsoft Internet Explorer 10-11
         window.navigator.msSaveOrOpenBlob(blob, fileName);
     } else {
         var blob = new Blob(["\ufeff" + content], {type: 'text/csv'}); //解决大文件下载失败
         var a = document.getElementById("exportCSVlink");
         a.download = fileName;
         a.href = URL.createObjectURL(blob);
         a.click();
     }
}
// 复制AP文本到剪贴板
function copyAPInformation() {

	var ckbs = $("input[name=ckb]:checked");
	var content = "";
	ckbs.each(function() {
		var apId = $(this).val();
		var aplist = inventory.apList;
		var atlist = inventory.atList;
		var html = "";
		if (aplist) {
			var len = aplist.length;
			for (var i = 0; i < len; i++) {
				if (aplist[i].apId == apId) {

					var apband = aplist[i].bandList.length;
					for (var j = 0; j < aplist[i].bandList.length; j++) {
						if (j == 0) {
							content += aplist[i].apName + "\t";
							content += aplist[i].apModel + "\t";
						} else {
							content += " " + "\t";
							content += " " + "\t";
						}
						var state = "Off";
						if (aplist[i].bandList[j].enable == 0) {
							state = "On";

						}
						content += aplist[i].bandList[j].bandName + "GHz "
								+ state + "\t";
						content += aplist[i].bandList[j].apMode + "\t";
						content += aplist[i].bandList[j].channel + "\t";
						content += aplist[i].bandList[j].channelSize + " MHz\t";
						content += aplist[i].bandList[j].pt + " dBm\t";
						if (j == 0) {
							content += aplist[i].apLocation + "\n";
						} else {
							content += " " + "\n";
						}

					}
					break;
				}

			}
		}

	});
	return content;

}
// 有修改时，更新页面缓存信息
function resetChache(ap, band) {

	for (var i = 0; i < inventory.apList.length; i++) {
		if (ap != null) {
			if (inventory.apList[i].apId == ap.apId) {
				inventory.apList[i].apName = ap.apName;
				inventory.apList[i].apLocation = ap.apLocation;
				break;
			}
		} else {
			if (inventory.apList[i].apId == band.apId) {
				if (inventory.apList[i].bandList != null) {
					for (var j = 0; j < inventory.apList[i].bandList.length; j++) {
						if (inventory.apList[i].bandList[j].bandName == band.bandName) {
							inventory.apList[i].bandList[j].enable = band.enable;
							if (band.enable == "0") {
								inventory.apList[i].bandList[j].channel = band.channel;
								inventory.apList[i].bandList[j].apMode = band.apMode;
								inventory.apList[i].bandList[j].channelSize = band.channelSize;
								inventory.apList[i].bandList[j].pt = band.pt;
							}
						}
					}
				}
			}
		}
	}
}
function saveInventory(index, curRow, iscur, preRow) {

	var ap = {};
	var at = {};
	var band = {};
	ap.apId = curRow.cells[0].childNodes[0].value;
	if (iscur && (index == 1 || index == 8)) {
		ap.apId = curRow.cells[0].childNodes[0].childNodes[0].value;
		ap.apName = curRow.cells[1].innerText;
		var location = curRow.cells[8].innerText;
		ap.apLocation = location == "-" ? "" : location;
		doAction(loader.Request.FloorUpdateAp, ap, function(data) {
			if (!data || !data.success)
				return;
			resetChache(ap);
			// getFloorApInfoForCache(ap.apId);
		});
		return;
	}
	if (iscur) {
		band.apId = curRow.cells[0].childNodes[0].childNodes[0].value;
		band.model = curRow.cells[2].innerText;
		band.bandName = curRow.cells[3].id;
		band.pt = 0;
		if (curRow.cells[3].getAttribute("Value") == "0") {
			band.enable = 0;
			band.apMode = curRow.cells[4].getAttribute("Value");
			band.channel = curRow.cells[5].getAttribute("Value");
			band.channelSize = curRow.cells[6].getAttribute("Value");
			band.pt = curRow.cells[7].getAttribute("Value");
			if (index == 6 && band.bandName=='5.0') {
				var apType = getAPTypebyId(band.apId);
				curRow.cells[5].setAttribute("DataItems", getChannel5(
						band.channelSize, apType));
				var show = getCurrentChannel(band.channel,band.channelSize, apType);
				curRow.cells[5].setAttribute("Value", show);
				curRow.cells[5].innerText = show;
				band.channel=show;
			}
			var bandType = curRow.cells[2].getAttribute("Value");
			if (bandType == "2") {
				var nextRow = $(curRow).next().get(0);
				if (nextRow.cells[0].getAttribute("Value") == "0") {
					var band1 = {};
					band1.apId = band.apId;
					band1.model = band.model;
					if (band.bandName == "2.4") {
						band1.bandName = "5.0";
					} else {
						band1.bandName = "2.4";
					}
					band1.enable = 1;
					nextRow.cells[0].setAttribute("Value", "1");
					nextRow.cells[0].innerText = band1.bandName + "GHz Off";
					nextRow.cells[0].style.opacity = "0.5";
					nextRow.cells[1].style.opacity = "0.5";
					nextRow.cells[2].style.opacity = "0.5";
					nextRow.cells[3].style.opacity = "0.5";
					nextRow.cells[4].style.opacity = "0.5";
					nextRow.cells[1].removeAttribute('EditType');
					nextRow.cells[2].removeAttribute('EditType');
					nextRow.cells[3].removeAttribute('EditType');
					nextRow.cells[4].removeAttribute('EditType');
					doAction(loader.Request.FloorUpdateApRadio, band1,
							function(data) {
								if (!data || !data.success)
									return;
								resetChache(null, band1);
								// getFloorApInfoForCache(band1.apId);
							});
				}
			}
		} else {
			band.enable = 1;
		}
		doAction(loader.Request.FloorUpdateApRadio, band, function(data) {
			if (!data || !data.success)
				return;
			resetChache(null, band);
			// getFloorApInfoForCache(band.apId);
		});
		return;
	} else {
		band.apId = preRow.cells[0].childNodes[0].childNodes[0].value;
		band.model = preRow.cells[2].innerText;
		band.bandName = curRow.cells[0].id;
		if (curRow.cells[0].getAttribute("Value") == "0") {
			band.enable = 0;
			band.apMode = curRow.cells[1].getAttribute("Value");
			band.channel = curRow.cells[2].getAttribute("Value");
			band.channelSize = curRow.cells[3].getAttribute("Value");
			if (index == 3 && band.bandName == '5.0') {
				var apType = getAPTypebyId(band.apId);
				curRow.cells[2].setAttribute("DataItems", getChannel5(
						band.channelSize, apType));
				var show = getCurrentChannel(band.channel,band.channelSize, apType);
				curRow.cells[2].setAttribute("Value", show);
				curRow.cells[2].innerText = show;
				band.channel=show;
			}
			band.pt = curRow.cells[4].getAttribute("Value");
			var bandType = preRow.cells[2].getAttribute("Value");
			if (bandType == "2") {
				if (preRow.cells[3].getAttribute("Value") == "0") {
					var band1 = {};
					band1.apId = band.apId;
					band1.model = band.model;
					band1.bandName = preRow.cells[3].id;
					band1.enable = 1;
					preRow.cells[3].innerText = band1.bandName + "GHz Off";
					preRow.cells[3].setAttribute("Value", "1");
					preRow.cells[3].style.opacity = "0.5";
					preRow.cells[4].style.opacity = "0.5";
					preRow.cells[5].style.opacity = "0.5";
					preRow.cells[6].style.opacity = "0.5";
					preRow.cells[7].style.opacity = "0.5";
					preRow.cells[4].removeAttribute('EditType');
					preRow.cells[5].removeAttribute('EditType');
					preRow.cells[6].removeAttribute('EditType');
					preRow.cells[7].removeAttribute('EditType');
					doAction(loader.Request.FloorUpdateApRadio, band1,
							function(data) {
								if (!data || !data.success)
									return;
								resetChache(null, band1);
								// getFloorApInfoForCache(band1.apId);
							});
				}
			}
		} else {
			band.enable = 1;
		}

		doAction(loader.Request.FloorUpdateApRadio, band, function(data) {
			if (!data || !data.success)
				return;
			resetChache(null, band);
			// getFloorApInfoForCache(band.apId);
		});
		return;
	}
}

/*
 * 清空搜索框文本，X图标变搜索图标
 */
function clearSearchValue(sender) {
	if ($(sender).hasClass("search-remove")) {
		$("#Tablesearch").val("");
		$(sender).removeClass("search-remove").addClass("search-search");
		showInventoryInfo(inventory);
		$('table#inventoryTable').editTable();
	}
}
function clearInventorySearch() {
	$('.searchap.input-field input').val('');
	$('.searchap.input-field').hide();
	$('#btnSearchInventory').show();
	showInventoryInfo(inventory);
	$('table#inventoryTable').editTable();
}
$(document).ready(function() {
	$("#Tablesearch").on('input', function() {
		if (inventory) {
			var search = $(this).val();
			if (search && search != "") {
				showInventoryInfo(inventory, search);
			} else {
				showInventoryInfo(inventory);
			}
			$("#actionDiv li.copyap").hide();
			$("#actionDiv li.deleteap").hide();
			$("#actionDiv li.exportcsv").hide();
			$('table#inventoryTable').editTable();
		}
	});
});