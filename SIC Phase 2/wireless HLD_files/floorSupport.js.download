/**
 * 
 */
function checkFloorNumLimit() {
	let curProjectFloorNum = global.floorList.length;
	let curAllProjectFloorNum = 0;

	global.projectList.forEach(prj => {
		if (global.currentProject.projectId != prj.projectId) {
			curAllProjectFloorNum += prj.floors.length;
		}
	});
	curAllProjectFloorNum += curProjectFloorNum;
	if (curProjectFloorNum >= global.userinfo.perProject
		|| curAllProjectFloorNum >= global.userinfo.totalProject) {

		return false;
	}

	return true;
}

function DuplicateFloor(floorId) {
	var param = {
		sourceId : floorId
	};
	doActionParam(loader.Request.CopyFloor, param, function(data) {
		if (data && data.success) {
			toggleCard('#floor_listview', '#floorCreate');
			loadFloors();
		}
	});
}
function showDuplicateFloor() {
	DuplicateFloor(global.menuFloor);
}
function showRenameFloor() {
	if(global.showIcon){
		$("#p_" + global.menuFloor).hide();
		$("#input_" + global.menuFloor).show();
	}else{
		$("#" + global.menuFloor).hide();
		$("#input_" + global.menuFloor).show();
	}
	
}
function showRenameFloorIcon(sender, floorId) {
	$(sender).hide();
	$("#input_" + floorId).show();
}

// 显示删除floor提示
function showDeleteFloorTip(floorId) {
	$("#view_" + floorId).hide();
	$("#delTip_" + floorId).show();
}
function hideDeleteFloorTip(floorId) {
	$("#delTip_" + floorId).hide();
	$("#view_" + floorId).show();
}
function showFloorDelTip_list() {
	if(global.showIcon){
		showDeleteFloorTip(global.menuFloor);
	}else{
		var souEle = $('#' + global.menuFloor);
		var sWidth = souEle.outerWidth();
		var sHeight = souEle.outerHeight();
		var sOffsetL = 21;
		// souEle.css("top");
		var sOffsetT = souEle.offset().top + sHeight - 1;
		var destEle = $("#floor-deleteFloorTip");
		souEle.addClass("icon-active ");
		destEle.css("left", sOffsetL);
		destEle.css("top", sOffsetT);
		destEle.show();
	}

}
function deleteFloor_list() {
	deleteFloor(global.menuFloor);
}
function hideDeleteFloorTip_list() {
	$("#floor-deleteFloorTip").hide();
}
function deleteFloor(floorId) {
	hideDeleteFloorTip_list();
	hideDeleteFloorTip();
	var jsondata = {
		floorId : floorId
	};
	doAction(loader.Request.FloorDelete, jsondata, function(data) {
		if (data && data.success) {
			for (var i = 0; i < global.floorList.length; i++) {
				if (global.floorList[i].floorId == floorId) {
					global.floorList.splice(i, 1);
					break;
				}
			}			
			if (global.showIcon) {
				showICONItem();
			} else {
				showListItem();
			}

			let addFloorPlanStr = "Add floor plan";

			if (global.floorList && global.floorList.length > 0) {
				$("#rightContainer").show();
				if (floorId == global.currentFloor.floorId)
					getFloorDetail(global.floorList[0].floorId);
				$('#left_bottom span').html(
						data.floorList.length + " Floor Plan");
				if(checkFloorNumLimit()) {
					$(".floorplan.disabled").removeClass("disabled");
					$(".floorplan a").attr("title", addFloorPlanStr);
				}
			} else {
				$("#floor_listview .collection").html("");
				showaddFloorCard();
				if(checkFloorNumLimit()) {
					$(".floorplan.disabled").removeClass("disabled");
					$(".floorplan a").attr("title", addFloorPlanStr);
					$(".addFloorPlus a").attr("title", addFloorPlanStr);
				}
				$("#rightContainer").hide();
			}
		}
	});
}
function showAdvisorModal(sender) {
	
	if ($(sender).hasClass('disabled'))
		return;
	if (rulerline.x1) {
		rulerline = {};
		resetMaincontext();
	}
	changeHand();
	$(sender).addClass('active');
	initapListForAdvisor(global.apList);
	initAdvisor();
	showDialog('advisorModal');

}
function showAddAPModal(sender) {
	
	if ($(sender).hasClass('disabled'))
		return;
	if (rulerline.x1) {
		rulerline = {};
		resetMaincontext();
	}
	$(sender).addClass('active');

	$('ul.tabs').tabs('select_tab', 'indoor-div');
	clearAPSearch();
	showDialog('addAPModal');

	if (!global.objshow.ap) {
		changeShow($("#menuLayerSub ul li a:eq(3)"), 'ap');
	}

	if(global.currentFloor.floorType==0){		
		$('ul.tabs').tabs('select_tab', 'indoor-div');
		$("#outdoor-div").hide();
		$("#indoor-div").show();
	}else{
		$('ul.tabs').tabs('select_tab', 'outdoor-div');
		$("#indoor-div").hide();
		$("#outdoor-div").show();
	}
	
	changeHand();
}
function runAutoChannel(sender) {

	if ($(sender).hasClass('disabled'))
		return;
	if (rulerline.x1) {
		rulerline = {};
		resetMaincontext();
	}
	$(sender).addClass('active');
	showDialog('waitingPModal');
	autoChannelAdvisor();
}
function openOptimizer(sender) {
	
	if ($(sender).hasClass('disabled'))
		return;
	$(sender).addClass('active');
	showDialog('optimizerModal');
}

function runOptimizer() {
	
	if (rulerline.x1) {
		rulerline = {};
		resetMaincontext();
	}	
	closeDialog('optimizerModal');
	showDialog('waitingPModal');
	autoPlacementAdvisor();
}
function showInventoryModal(sender) {
	
	if ($(sender).hasClass('disabled'))
		return;
	if (rulerline.x1) {
		rulerline = {};
		resetMaincontext();
	}
	$(sender).addClass('active');
	showInventory();
	showDialog('inventoryModal');
	var height = $("#inventoryModal").height();
	$("#tbdiv").css("height", height - 214);
	$("#noResultDiv").css("height", height - 214);
	changeHand();
}

function runHeatMap(sender) {
	
	if ($(sender).hasClass('disabled'))
		return;
	
	if (global.currentFloor.floorType == 0) {

		if (rulerline.x1) {
			rulerline = {};
			resetMaincontext();
		}
		if (global.showheatmap) {
			changeShowHeatMap('Off');
			closeDialog('waitingPModal');
		} else {
			showDialog('waitingPModal');
			changeShowHeatMap('On');
			// closeWDS();
		}
	} else {
		global.showheatmap = !global.showheatmap;

		if (global.showheatmap) {
			var param = {
				"floorId" : global.currentFloor.floorId,
				"band" : global.currentBand,
				"channel" : global.currentChannel
			};

			doActionParam(loader.Request.FloorOutdoorCoverage, param,
					function(data) {

				console.log(data);
				global.coverages=data.data;
				refreshDataDraw();
					});
		}else{
			global.coverage=null;
			refreshDataDraw();
		}		
	}

}

function closeHeatMap(sender) {

}

function resetHeatMap() {
	if (global.showheatmap) {
		$("#btnHeatmap").parent().addClass('active');
		$("#btnHeatmap_min").parent().addClass('active');
		$("#btnCloseHeatmap").parent().show();
		$("#btnCloseHeatmap_min").parent().show();
	} else {
		$("#btnHeatmap").parent().removeClass('active');
		$("#btnHeatmap_min").parent().removeClass('active');
		$("#btnCloseHeatmap").parent().hide();
		$("#btnCloseHeatmap_min").parent().hide();
	}
}

function runWDS(sender) {
	
	if ($(sender).hasClass('disabled'))
		return;
	$("#menuDiv").css("display", "none");
	$(".floor_topmenu .env-item").addClass("disabled");
	$(".floor_topmenu .dev-item").addClass("disabled");
	$(".floor_topmenu .dropdown-button").removeAttr('data-activates');
	global.showWDS = true;	
	$("#wdsMenu").addClass("active");
	$("#btnCloseWDS").show();
	closeHeatMap();	
	
	if(global.currentFloor.floorType==0){
		if (rulerline.x1) {
			rulerline = {};
		}
		
		resetHeatcontext();
		resetMaincontext();
		
	}else{
		showWdsCreateStart();
		refreshDataDraw();
	}
	resetDropdown();
}
function closeWDS(sender) {
	global.showWDS = false;
	$("#btnCloseWDS").hide();
	$("#menuDiv").css("display", "block");
	$("#wdsMenu").removeClass("active");
	$(".floor_topmenu .env-item").removeClass("disabled");
	$(".floor_topmenu .dev-item").removeClass("disabled");
	$('#dropdown_zonebtn').attr('data-activates', 'dropdown_zone');
	$('#dropdown_obsbtn').attr('data-activates', 'dropdown_obs');
	$('#dropdown_areabtn').attr('data-activates', 'dropdown_area');
	if (global.currentFloor.floorType == 0) {
		resetHeatcontext();
		resetMaincontext();
	} else {
		refreshDataDraw();
	}
	resetDropdown();
}

function showReport() {
	toggleCard(".report_listview", "#floor_listview");
	$("#showReport").hide();
	$("#downloadReport").show();
	$("#backFloorPlan").show();
	
	getReportNav();

	initReport(global.currentProject);
	common.changeDivHeight();

}
function showDownloadReport() {
	loadFloorchecklist();
	showDialog('exportPDFModal');

}
function closeDownloadReport() {
	closeDialog('exportPDFModal');
}
function backtoFloorPlan() {
	$("#downloadReport").hide();
	$("#backFloorPlan").hide();
	$('#showReport').show();
	getFloorPlanNav(global.currentFloor);
	toggleCard("#floor_listview", ".report_listview");
	common.changeDivHeight();
}
function searchAPOnAPlist(sender) {
	var result = [];
	var tag = $(sender).val();
	var reg = new RegExp(tag, 'i');
	for (var i = 0; i < global.apList.length; i++) {
		if (global.apList[i].apModelName.match(reg)) {
			result.push(global.apList[i]);
		}
	}
	initapList(result);

}
function clearAPSearch() {
	$('.searchap.input-field input').val('');
	$('.searchap.input-field').hide();
	$('#btnSearch').show();
	initapList(global.apList);
}
function addNewAP() {
	closeDialog('addAPModal');
	
	var ap = global.selectedAP.replace(/ap_/, "");
	if(global.currentFloor.floorType==0){
		newAP(ap);
	}else{
		newGoogleAP(ap);
	}
}