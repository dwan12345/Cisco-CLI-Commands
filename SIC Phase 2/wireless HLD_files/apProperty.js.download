var slider24 = document.getElementById('power24Range');
noUiSlider.create(slider24, {
	start : 26,
	step : 1,
	connect : true,
	range : {
		'min' : 1,
		'max' : 26
	},
	format : wNumb({
		decimals : 0
	})
});
slider24.noUiSlider.on('update', function(values, handle) {
	$("#power24Label").html(Math.round(values[handle]));
	power24Value = Math.round(values[handle]);
});
slider24.noUiSlider.on('change', function(values, handle) {
	power24Value = Math.round(values[handle]);
	updateApRadio24();
});
var slider5 = document.getElementById('power5Range');
noUiSlider.create(slider5, {
	start : 26,
	step : 1,
	connect : true,
	range : {
		'min' : 1,
		'max' : 26
	},
	format : wNumb({
		decimals : 0
	})
});
slider5.noUiSlider.on('update', function(values, handle) {
	$("#power5Label").html(Math.round(values[handle]));
	power5Value = Math.round(values[handle]);

});
slider5.noUiSlider.on('change', function(values, handle) {
	power24Value = Math.round(values[handle]);
	updateApRadio5();
});
var slider6 = document.getElementById('power6Range');
noUiSlider.create(slider6, {
	start : 26,
	step : 1,
	connect : true,
	range : {
		'min' : 1,
		'max' : 26
	},
	format : wNumb({
		decimals : 0
	})
});
slider6.noUiSlider.on('update', function(values, handle) {
	$("#power6Label").html(Math.round(values[handle]));
	power6Value = Math.round(values[handle]);

});
slider6.noUiSlider.on('change', function(values, handle) {
	power6Value = Math.round(values[handle]);
	updateApRadio6();
});
var power5Value = 0;
var power24Value = 0;
var power6Value = 0;
function updateApBase() {
	if (global.currentAP) {
		global.currentAP.apName = $("#apname").val();
		global.currentAP.apLocation = $("#aplocation").val();

		FloorUpdateAp(global.currentAP, function() {
		});
		propertyRefresh();
	}
}

function changeEnable24() {
	if (global.currentAP.bandType == 2) {
		if ($("#enable24").prop("checked")
				&& $("#band5Base").css("display") != 'none') {
			$("#enable5").prop("checked", false);
			updateApRadio5();
		}
	}
	updateApRadio24();
}

function changeEnable5() {
	if (global.currentAP.bandType == 2) {
		if ($("#enable5").prop("checked")
				&& $("#band24Base").css("display") != 'none') {
			$("#enable24").prop("checked", false);
			updateApRadio24();
		}
	}
	updateApRadio5();
}

function changeEnable6() {
	updateApRadio6();
}

function updateApRadio24() {

	if ($("#band24Base").attr("dispaly") != "none") {
		var jsondata = {
			apId : global.currentAP.apId,
			bandName : "2.4",
			channel : $("#channel24").val(),
			pt : power24Value,
			enable : $("#enable24").prop("checked") ? 0 : 1,
			//apMode : $("#apMode24").val(),
			channelSize : $("#channelSize24").val(),
			wdsMode : $("#bridge24").prop("checked") ? "bridge" : "point"
		};

		for (var i = 0; i < global.currentAP.bandList.length; i++) {
			if (global.currentAP.bandList[i].bandName == "2.4") {
				global.currentAP.bandList[i].channel = jsondata.channel;
				global.currentAP.bandList[i].pt = jsondata.pt;
				global.currentAP.bandList[i].enable = jsondata.enable;
				global.currentAP.bandList[i].apMode = jsondata.apMode;
				global.currentAP.bandList[i].channelSize = jsondata.channelSize;
				global.currentAP.bandList[i].wdsMode = jsondata.wdsMode;
			}
		}
		// $("#power24Label").html($("#power24Range").val());

		doAction(loader.Request.FloorUpdateApRadio, jsondata, function() {
			showDialog('waitingPModal');
			showHeatMapModal();
			//refreshWds();
			refreshFloorDetail();
		});
		propertyRefresh();
	}
}

function updateApRadio5() {
	if ($("#band5Base").attr("dispaly") != "none") {
		var jsondata = {
			apId : global.currentAP.apId,
			bandName : "5.0",
			channel : $("#channel5").val(),
			pt : power5Value,
			enable : $("#enable5").prop("checked") ? 0 : 1,
			//apMode : $("#apMode5").val(),
			channelSize : $("#channelSize5").val(),
			wdsMode : $("#bridge5").prop("checked") ? "bridge" : "point"
		};

		for (var i = 0; i < global.currentAP.bandList.length; i++) {
			if (global.currentAP.bandList[i].bandName == "5.0") {
				global.currentAP.bandList[i].channel = jsondata.channel;
				global.currentAP.bandList[i].pt = jsondata.pt;
				global.currentAP.bandList[i].enable = jsondata.enable;
				global.currentAP.bandList[i].apMode = jsondata.apMode;
				global.currentAP.bandList[i].channelSize = jsondata.channelSize;
				global.currentAP.bandList[i].wdsMode = jsondata.wdsMode;
			}
		}
		// $("#power5Label").html($("#power5Range").val());
		doAction(loader.Request.FloorUpdateApRadio, jsondata, function() {
			showDialog('waitingPModal');
			showHeatMapModal();
			//refreshWds();
			refreshFloorDetail();
		});
		propertyRefresh();
	}
}
function updateChannel5List(){
	 var channelsize= $("#channelSize5").val();
	 var channel5=$("#channel5").val();
	 $("#channel5").html(getChannelhtml("5",channelsize,global.currentAP.apType));
	 var channel51=getCurrentChannel(channel5,channelsize,global.currentAP.apType);
	 $("#channel5").val(channel51);
	 Materialize.updateTextFields();
		$('select').material_select();
		if(channel5!=channel51){
			updateApRadio5();
		}
}

function updateApRadio6() {
	if ($("#band6Base").attr("dispaly") != "none") {
		var jsondata = {
			apId : global.currentAP.apId,
			bandName : "6.0",
			channel : $("#channel6").val(),
			pt : power6Value,
			enable : $("#enable6").prop("checked") ? 0 : 1,
			channelSize : $("#channelSize6").val(),
			wdsMode : $("#bridge6").prop("checked") ? "bridge" : "point"
		};

		for (var i = 0; i < global.currentAP.bandList.length; i++) {
			if (global.currentAP.bandList[i].bandName == "6.0") {
				global.currentAP.bandList[i].channel = jsondata.channel;
				global.currentAP.bandList[i].pt = jsondata.pt;
				global.currentAP.bandList[i].enable = jsondata.enable;
				global.currentAP.bandList[i].apMode = jsondata.apMode;
				global.currentAP.bandList[i].channelSize = jsondata.channelSize;
				global.currentAP.bandList[i].wdsMode = jsondata.wdsMode;
			}
		}

		doAction(loader.Request.FloorUpdateApRadio, jsondata, function() {
			showDialog('waitingPModal');
			showHeatMapModal();
			//refreshWds();
			refreshFloorDetail();
		});
		propertyRefresh();
	}
}
function updateChannel6List(){
	var channelsize= $("#channelSize6").val();
	var channel6=$("#channel6").val();
	$("#channel6").html(getChannelhtml("6",channelsize,global.currentAP.apType));
	var channel61=getCurrentChannel(channel6,channelsize,global.currentAP.apType);
	$("#channel6").val(channel61);
	Materialize.updateTextFields();
	 $('select').material_select();
	 if(channel6!=channel61){
		 updateApRadio6();
	 }
}

function hideAPSettingPanel() {
	$("#apPropertyDiv").hide();

	global.currentAP = null;
}

function showAPSettingPanel(apId) {
	var height = $("#canvasdiv").height();
	$("#PropertyDivMain").css("height", height - 39 + "px");
	global.currentAP = obstructions.get(apId);
	showAPProperty();
	$("#apPropertyDiv").show();

}
var externalAt=true;
function showAPProperty() {
	$("#apli").addClass("active");
	$("#Radiationli").removeClass("active");
	$("#Antennali").removeClass("active");
	$("#apPropertyDivMain").show();
	$("#RadiationPropertyDivMain").hide();
	$("#AntennaPropertyDivMain").hide();

	if (global.currentAP) {
		$("#apname").val(global.currentAP.apName);
		$("#aplocation").val(global.currentAP.apLocation);
		$("#apModel").html(global.currentAP.apModel);
		// $("#protocol").html(global.currentAP.protocol);
		$("#protocol").html(getProtocol(global.currentAP));
		var band24 = null, band5 = null, band6 = null;
		for (var i = 0; i < global.currentAP.bandList.length; i++) {
			if (global.currentAP.bandList[i].bandName == "2.4") {
				band24 = global.currentAP.bandList[i];

			} else if (global.currentAP.bandList[i].bandName == "5.0") {
				if (global.currentAP.apType == 0) {
					if (global.support.band5In) {
						band5 = global.currentAP.bandList[i];
					}
				} else {
					if (global.support.band5Out) {
						band5 = global.currentAP.bandList[i];
					}
				}
			}
			else if (global.currentAP.bandList[i].bandName == "6.0") {
				if (global.currentAP.apType == 0) {
					if (global.support.band6In) {
						band6 = global.currentAP.bandList[i];
					}
				} else {
					if (global.support.band6Out) {
						band6 = global.currentAP.bandList[i];
					}
				}
			}
		}

		if (band24 != null) {
			$("#band24Base").show();
			slider24.noUiSlider.updateOptions({
				range : {
					'min' : 1,
					'max' : band24.defaultPt
				}
			});
			slider24.noUiSlider.set(band24.pt);
			if (band24.enable == 0) {
				$("#enable24").prop("checked", true);
				// $("#enable24").attr("checked", 'checked');
			} else {
				// $("#enable24").removeAttr("checked");
				$("#enable24").prop("checked", false);
			}
			$("#channel24").html(getChannelhtml("2.4"));
			$("#channel24").val(band24.channel);
			$("#apMode24").html(band24.apMode+" Mode");
			/*if (band24.apMode == "AP") {
				$("#apMode24 option:eq(0)").removeAttr("disabled");
				$("#apMode24 option:eq(1)").attr("disabled", "disabled");
			} else {
				$("#apMode24 option:eq(1)").removeAttr("disabled");
				$("#apMode24 option:eq(0)").attr("disabled", "disabled");
			}*/

			$("#channelSize24").val(band24.channelSize);
			if (band24.apMode == "AP") {
				$("#wdsModeLabel24").hide();
				$("#wdsModeValue24").hide();
			} else {
				$("#wdsModeLabel24").show();
				$("#wdsModeValue24").show();
				if (band24.wdsMode == "point") {
					$("#point24").prop("checked", true);
				} else {
					$("#bridge24").prop("checked", true);
				}
			}
			if(band24.externalAt==1){
				externalAt=true;
			}else{
				externalAt=false;
			}
		} else {
			$("#band24Base").hide();
		}

		if (band5 != null) {
			$("#band5Base").show();
			slider5.noUiSlider.updateOptions({
				range : {
					'min' : 1,
					'max' : band5.defaultPt
				}
			});
			slider5.noUiSlider.set(band5.pt);
			if (band5.enable == 0) {
				$("#enable5").prop("checked", true);
				// $("#enable5").attr("checked", 'checked');
			} else {
				// $("#enable5").removeAttr("checked");
				$("#enable5").prop("checked", false);
			}

			$("#channel5").html(getChannelhtml("5",band5.channelSize,global.currentAP.apType));
			$("#channel5").val(band5.channel);
			$("#apMode5").html(band5.apMode+" Mode");
			/*if (band5.apMode == "AP") {
				$("#apMode5 option:eq(0)").removeAttr("disabled");
				$("#apMode5 option:eq(1)").attr("disabled", "disabled");
			} else {
				$("#apMode5 option:eq(1)").removeAttr("disabled");
				$("#apMode5 option:eq(0)").attr("disabled", "disabled");
			}*/
			$("#channelSize5").html(getChannelSizehtml(band5.protocol, global.currentAP.apType, '5'));
			$("#channelSize5").val(band5.channelSize);
			if (band5.apMode == "AP") {
				$("#wdsModeLabel5").hide();
				$("#wdsModeValue5").hide();
			} else {
				$("#wdsModeLabel5").show();
				$("#wdsModeValue5").show();
				if (band5.wdsMode == "point") {
					$("#point5").prop("checked", true);
				} else {
					$("#bridge5").prop("checked", true);
				}
			}
			if(band5.externalAt==1){
				externalAt=true;
			}else{
				externalAt=false;
			}
		} else {
			$("#band5Base").hide();
		}

		if (band6 != null) {
			$("#band6Base").show();
			slider6.noUiSlider.updateOptions({
				range : {
					'min' : 1,
					'max' : band6.defaultPt
				}
			});
			slider6.noUiSlider.set(band6.pt);
			if (band6.enable == 0) {
				$("#enable6").prop("checked", true);
			} else {
				$("#enable6").prop("checked", false);
			}

			$("#channel6").html(getChannelhtml("6",band6.channelSize,global.currentAP.apType));
			$("#channel6").val(band6.channel);
			$("#apMode6").html(band6.apMode+" Mode");

			$("#channelSize6").html(getChannelSizehtml(band6.protocol, global.currentAP.apType, '6'));
			$("#channelSize6").val(band6.channelSize);
			if (band6.apMode == "AP") {
				$("#wdsModeLabel6").hide();
				$("#wdsModeValue6").hide();
			} else {
				$("#wdsModeLabel6").show();
				$("#wdsModeValue6").show();
				if (band6.wdsMode == "point") {
					$("#point6").prop("checked", true);
				} else {
					$("#bridge6").prop("checked", true);
				}
			}
			if(band6.externalAt==1){
				externalAt=true;
			}else{
				externalAt=false;
			}
		}
		else {
			$("#band6Base").hide();
		}
	}
	Materialize.updateTextFields();
	$('select').material_select();
	if(externalAt){
		$("#Antennali").show();
	}else{
		$("#Antennali").hide();
	}
}
function getChannelSizehtml(flag,apType, bandName){
	var option="";
	option+="<option value='20'>20MHz</option>";
	const typeString = apType === 0 ? `ch${bandName}str` : `ch${bandName}Outstr`;
	const channelSizeArray = bandName === '6' ? [ 40, 80, 160, 320 ] : [ 40, 80 ]; // 5G temp only support to 80 (2024.07.29)

	channelSizeArray.forEach(chVal => {
		if (global.channel[`${typeString}${chVal}`] !== '')  {
			if ((chVal === 80 && flag.indexOf('ac') === -1)
				||(chVal === 160 && flag.indexOf('ax') === -1)
				||(chVal === 320 && flag.indexOf('be') === -1)) {
				return;
			}
			else {
				option += `<option value='${chVal}'>${chVal}MHz</option>`
			}
		}
	});

	return option;
}
function getChannelhtml(flag,channelSize,apType) {
	var items = [];
	if (flag == '2.4') {
		items = eval(getChannel24());
	} else if (flag === '5') {
		items = eval(getChannel5(channelSize,apType));
	}
	else if (flag === '6') {
		items = eval(getChannel6(channelSize, apType));
	}
	var oOption = "";
	for (var i = 0; i < items.length; i++) {
		oOption += "<option value=" + items[i].value + ">" + items[i].text
				+ "</option>";
	}
	return oOption;
}


function showRadiationProperty() {
	$("#Radiationli").addClass("active");
	$("#apli").removeClass("active");
	$("#Antennali").removeClass("active");
	$("#apPropertyDivMain").hide();
	$("#RadiationPropertyDivMain").show();
	$("#AntennaPropertyDivMain").hide();

	if (global.currentAP) {
		var eplane24 = "resource/AP/RF_Pattern/" + global.currentAP.apModel
				+ "_2.4G_E.png";
		var hplane24 = "resource/AP/RF_Pattern/" + global.currentAP.apModel
				+ "_2.4G_H.png";
		var eplane5 = "resource/AP/RF_Pattern/" + global.currentAP.apModel
				+ "_5G_E.png";
		var hplane5 = "resource/AP/RF_Pattern/" + global.currentAP.apModel
				+ "_5G_H.png";

		const ehPlaneModels = ['ECW336', 'ECW516L', 'ECW520']
		const isEHPlaneModel = ehPlaneModels.includes(global.currentAP.apModel);
		const imgPathE = isEHPlaneModel ? 'E' : 'XY';
		const imgPathH = isEHPlaneModel ? 'H' : 'YZ';
		// $('#plane-name1-6g').text(`${imgPathE}-PLANE`);
		// $('#plane-name2-6g').text(`${imgPathH}-PLANE`);
		const xyPlane6 = `resource/AP/RF_Pattern/${global.currentAP.apModel}_6G_${imgPathE}.png`;
		const yzPlane6 = `resource/AP/RF_Pattern/${global.currentAP.apModel}_6G_${imgPathH}.png`;

		var band24 = null, band5 = null, band6 = null;
		for (var i = 0; i < global.currentAP.bandList.length; i++) {
			if (global.currentAP.bandList[i].bandName == "2.4") {
				band24 = global.currentAP.bandList[i];

			} else if (global.currentAP.bandList[i].bandName == "5.0") {
				if (global.currentAP.apType == 0) {
					if (global.support.band5In) {
						band5 = global.currentAP.bandList[i];
					}
				} else {
					if (global.support.band5Out) {
						band5 = global.currentAP.bandList[i];
					}
				}
			}
			else if (global.currentAP.bandList[i].bandName == "6.0") {
				if (global.currentAP.apType == 0) {
					if (global.support.band6In) {
						band6 = global.currentAP.bandList[i];
					}
				} else {
					if (global.support.band6Out) {
						band6 = global.currentAP.bandList[i];
					}
				}
			}
		}

		if (band24 != null) {
			$("#band24Radiation").show();
			$("#eplane24").attr("src", eplane24);
			$("#hplane24").attr("src", hplane24);
		} else {
			$("#band24Radiation").hide();
		}

		if (band5 != null) {
			$("#band5Radiation").show();
			$("#eplane5").attr("src", eplane5);
			$("#hplane5").attr("src", hplane5);
		} else {
			$("#band5Radiation").hide();
		}

		if (band6 !== null) {
			$("#band6Radiation").show();
			$("#xyplane6").attr("src", xyPlane6);
			$("#yzplane6").attr("src", yzPlane6);
		}
		else {
			$("#band6Radiation").hide();
		}
	}
}

function showAntennaProperty() {
	$("#Antennali").addClass("active");
	$("#apli").removeClass("active");
	$("#Radiationli").removeClass("active");
	$("#apPropertyDivMain").hide();
	$("#RadiationPropertyDivMain").hide();
	$("#AntennaPropertyDivMain").show();
	var band24 = null, band5 = null;
	for (var i = 0; i < global.currentAP.bandList.length; i++) {
		if (global.currentAP.bandList[i].bandName == "2.4") {
			band24 = global.currentAP.bandList[i];

		} else if (global.currentAP.bandList[i].bandName == "5.0") {
			if (global.currentAP.apType == 0) {
				if (global.support.band5In) {
					band5 = global.currentAP.bandList[i];
				}
			} else {
				if (global.support.band5Out) {
					band5 = global.currentAP.bandList[i];
				}
			}
		}
	}
	if (band24 != null) {
		$("#antenna24").show();
	} else {
		$("#antenna24").hide();
	}
	if (band5 != null) {
		$("#antenna5").show();
	} else {
		$("#antenna5").hide();
	}
	/*
	 * $("#antenna24").show(); $("#antenna5").show();
	 */
	$("#antenna24_0").hide();
	$("#antenna5_0").hide();
	if (!global.currentAP.attachedId) {

		var html5 = "";
		var html24 = "";

		for (var i = 0; i < global.atList.length; i++) {
			var at = global.atList[i];
			var type = at.antennaType == 0 ? "Omni" : "Directional";
			var html = '<li onclick="newAntenna(\'' + at.atModelName + '\','
					+ at.antennaType + ')">';
			html += '<div class="row">';
			html += '<div class="col s6">';
			html += '<span style="display:block;">' + at.atModelName
					+ '</span>';
			html += '<span style="display:block;">Type: ' + type + '</span>';
			html += '<span style="display:block;">Gain: ' + at.antennaGain
					+ ' dBi</span>';
			html += '</div>';
			html += '<div class="col s6">';
			html += '<img alt="" width="100%" src="resource/Antenna/'
					+ at.atModelName + '.png">';
			html += '</div>';
			html += '</div>';
			html += '</li>';

			if (at.bandName.indexOf("2.4")!=-1) {
				html24 += html;
			}
			if (at.bandName.indexOf("5.0")!=-1) {
				html5 += html;
			}
		}
		$("#dropdown_at5").html(html5);
		$("#dropdown_at24").html(html24);
		$("#antenna24_1").show();
		$("#antenna24_2").hide();
		$("#antenna24_3").hide();
		$("#antenna24_4").hide();
		$("#antenna5_1").show();
		$("#antenna5_2").hide();
		$("#antenna5_3").hide();
		$("#antenna5_4").hide();
	} else {
		$("#antenna24_1").hide();
		$("#antenna5_1").hide();
		var at = getatbyapId(global.currentAP.apId);
		if (at != null) {
			var html5 = "";
			var html24 = "";
			var type = at.antennaType == 0 ? "Omni" : "Directional";
			for (var j = 0; j < at.radioList.length; j++) {

				if (at.radioList[j].bandName == "2.4") {
					var radio24 = at.radioList[j];
					html24 += '<div class="col s2"><span class="Label24g">2.4GHz</span></div>';
					html24 += '<div class="col s5">';
					html24 += '<span style="display:block;">' + radio24.model
							+ '</span>';
					html24 += '<span style="display:block;">Type: ' + type
							+ '</span>';
					html24 += '<span style="display:block;">Gain: '
							+ radio24.pt + ' dBi</span>';
					html24 += '</div>';
					html24 += '<div class="col s4">';
					html24 += '<img alt="" width="100%" src="resource/Antenna/'
							+ radio24.model + '.png">';
					html24 += '</div>';
					html24 += '<div class="col s1 atdel" style="margin-left:-10">';
					html24 += '<a onclick="showDeleteAtPanel(\'24\');"><i class="fa fa-trash"></i></a>';
					html24 += '</div>';
					$("#antenna24_2").html(html24);

					html24 = "";
					html24 += '<div class="col s6">';
					html24 += '<img id="eplane5" alt="" src="resource/Antenna/RF_Pattern/'
							+ radio24.model + '_2.4G_E.svg"></div>';
					html24 += '<div class="col s6">';
					html24 += '<img id="hplane5" alt="" src="resource/Antenna/RF_Pattern/'
							+ radio24.model + '_2.4G_H.svg"></div>';
					$("#antenna24_4").html(html24);
				} else {
					radio5 = at.radioList[j];
					html5 += '<div class="col s2"><span class="Label5g">5GHz</span></div>';
					html5 += '<div class="col s5">';
					html5 += '<span style="display:block;">' + radio5.model
							+ '</span>';
					html5 += '<span style="display:block;">Type: ' + type
							+ '</span>';
					html5 += '<span style="display:block;">Gain: ' + radio5.pt
							+ ' dBi</span>';
					html5 += '</div>';
					html5 += '<div class="col s4">';
					html5 += '<img alt="" width="100%" src="resource/Antenna/'
							+ radio5.model + '.png">';
					html5 += '</div>';
					html5 += '<div class="col s1 atdel" style="margin-left:-10">';
					html5 += '<a onclick="showDeleteAtPanel(\'5\');"><i class="fa fa-trash"></i></a>';
					html5 += '</div>';
					$("#antenna5_2").html(html5);

					html5 = "";
					html5 += '<div class="col s6">';
					html5 += '<img id="eplane5" alt="" src="resource/Antenna/RF_Pattern/'
							+ radio5.model + '_5G_E.svg"></div>';
					html5 += '<div class="col s6">';
					html5 += '<img id="hplane5" alt="" src="resource/Antenna/RF_Pattern/'
							+ radio5.model + '_5G_H.svg"></div>';
					$("#antenna5_4").html(html5);
				}
			}

			if (html24 != "") {
				$("#antenna24_2").show();
				$("#antenna24_3").show();
				$("#antenna24_4").show();
			} else {
				$("#antenna24").hide();
			}

			if (html5 != "") {
				$("#antenna5_2").show();
				$("#antenna5_3").show();
				$("#antenna5_4").show();
			} else {
				$("#antenna5").hide();
			}
		}

	}
}

function showDeleteAtPanel(band) {
	if (band == "24") {
		$("#antenna24_2").hide();
		$("#antenna24_0").show();
	} else {
		$("#antenna5_2").hide();
		$("#antenna5_0").show();
	}
}

function hideDeleteAtPanel(band) {
	if (band == "24") {
		$("#antenna24_2").show();
		$("#antenna24_0").hide();
	} else {
		$("#antenna5_2").show();
		$("#antenna5_0").hide();
	}
}

function deleteAt() {
	if (global.currentFloor.floorType == 0) {
		var at = getatbyapId(global.currentAP.apId);
		if (at != null) {
			FloorDeleteAt(at.atId, at.apId, function(data) {
				console.log(data);
			});
			changeShowHeatMap();
			global.currentAP.attachedId = "";

			obstructions.push(at.atId, null);
			var ap = new AP(global.currentAP);
			obstructions.push(global.currentAP.Id, ap);
			resetHeatcontext();
			resetMaincontext();
			showAntennaProperty();
		}
	} else {
		var at = getatbyapId(global.currentAP.apId);
		if (at != null) {
			FloorDeleteAt(at.atId, at.apId, function(data) {
				refreshFloorDetail(function() {
					showAntennaProperty();
				});
			});

		}
	}
}

function newAntenna(atModel, antennaType) {

	if (global.currentFloor.floorType == 0) {
		var atId = (new UUID()).toString();

		var antenna = {
			atId : atId,
			apId : global.currentAP.apId,
			atModel : atModel,
			floorId : global.currentFloor.floorId,
			px : global.currentAP.px + SIDELENGTH_ANTENNA * 3,
			py : global.currentAP.py,
			antennaType : antennaType

		};

		doAction(loader.Request.FloorInsertAt, antenna, function(data) {
			if (!data || !data.success) {
				return;
			}

			changeShowHeatMap();

			var at = new Antenna(data.attached);
			obstructions.push(at.atId, at);

			global.currentAP = new AP(data.data);
			obstructions.push(global.currentAP.Id, global.currentAP);

			refreshWds();
			resetHeatcontext();
			resetMaincontext();

			showAntennaProperty();

		});
	} else {
		var atId = (new UUID()).toString();
		var scale = 1 << googleMap.getZoom();

		var antenna = {
			atId : atId,
			apId : global.currentAP.apId,
			atModel : atModel,
			floorId : global.currentFloor.floorId,
			px : global.currentAP.longitude + 100 / scale,
			py : global.currentAP.latitude,
			antennaType : antennaType

		};

		doAction(loader.Request.FloorInsertAt, antenna, function(data) {
			refreshFloorDetail(function() {
				showAntennaProperty();
			});

		});
	}

};
